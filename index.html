<!DOCTYPE html>
<html>
<head>
    <title>My Page</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.css">

    <style>
        a{
            text-decoration: none;
        }
        a.edit {
            float: left;
            margin-right:5%;
        }

        a.close {
            float: right;
        }

        textarea {
        	width:80%;
        }
        li.list {
            margin-left: 10%;
        }
    </style>
    <script src="https://code.jquery.com/jquery-1.8.2.min.js"></script>
    <script>
    	$(document).bind('mobileinit',function(){
        	$.mobile.changePage.defaults.changeHash = false;
        	$.mobile.hashListeningEnabled = false;
        	$.mobile.pushStateEnabled = false;
        	$.mobile.allowCrossDomainPages = true;
        });
    </script>
    <script src="https://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.js"></script>

</head>
<body>
	<div data-role="page">
		<div data-role="header">
			<h1>To-Do List</h1>
		</div>

		<div data-role="content">
            <!-- ul tag where all the items entered by the user are displayed-->
			<ul id="toDoItemList" data-role="listview" data-inset="true"></ul>
		</div>
        <!-- form to accept input from user-->
		<form action="#" method="post" id="listForm">
            <div data-role="fieldcontain">
                <label for="newItem">Enter to-do Item</label>
                <input type="text" placeholder="Enter your to-do item" id="newItem"/>
                <input id="addItem" type="submit" value="Add"/>
            </div>
        </form>
        <!-- pop up where the user will edit their to-do item-->
        <div data-role="popup" id="pop1" data-position-to="window">
            <a href="#" data-rel="back" data-role="button" data-theme="a" data-icon="delete" data-iconpos="notext" class="ui-btn-right">Close</a>
            <div data-role="header" data-theme="a">
                <h1>Edit your item</h1>
            </div>
            <p class="ui-bar ui-bar-e">
                <textarea id="editArea"></textarea>
                <a href="#" data-rel="back" data-role="button" data-theme="a" id="saveEdit">Save Changes</a>
            </p>
        </div>
	</div>
	<script>
	$(function(){

		var item = $("#newItem"),
            index,
            ItemList;

        //On form submit, push the item to array of to-do items, display the new array and store the array locally
		$("#listForm").on('submit', function(event){
            if(item.val() != ' '){
                var textContent = $("#newItem").val();
                ItemList.push(textContent);
                $("#newItem").val(" ");
                displayItems(ItemList);
                populateStorage('keys', ItemList);
                event.preventDefault();
                return false;
            }
            //if user accidentally clicks on 'add' without any content, prompt them to enter a value
            else{
                alert("Please enter a to-do item");
                $("#newItem").val(" ");
                event.preventDefault();
                return false;
            }
		});

        //editing a list item when tapped on edit button
		$("ul").delegate('li','tap click',function(event){
            index = $("li").index(this);
            var content = ItemList[index];
            $("pop1").val(content);
            $("#editArea").val(content);

            event.preventDefault();

            //listen to click event on 'save changes' button and save the new contents into the list item and items array, display the new array and store locally
            $("#saveEdit").click(function(event){
                ItemList[index] = $("#editArea").val();
                displayItems(ItemList);
                populateStorage('keys', ItemList);
                event.preventDefault();
            });
		});



        //delete a list item
        $("#toDoItemList").delegate('a.close','tap click',function(event){
            event.stopPropogation();
            //var t = event.target;
            //if(t.nodeName === 'A'){
                //if($(this).closest("li").hasClass('list')){
                    index = $(".close").index(this);
                    $("li").eq(index).remove();
                    ItemList.splice(index, 1);
                    console.log("storedItemList after deleting", ItemList, index);
                    populateStorage('keys', ItemList);
                    event.preventDefault();
                    return false;
                    //console.log("remove",this.closest("li"));
                    //this.closest("li").remove("li");
                    //ItemList.splice(index, 1);
                    //populateStorage('keys', ItemList);
                    //event.preventDefault();
                    //return false;
               // }
                /*else {
                    $(this).closest("li").addClass('list');
                }*/
           // }
           // event.preventDefault();
           // return false;
        });

        //fetch the list(array) of items from local storage and display them
        $(document).ready(function(){
                ItemList = getItems('keys'));
                displayItems(ItemList);
        });

        function getItems(value){
            if(localStorage[value]){
                return (JSON.parse(localStorage[value]));
            }
            else
                return [ ];
        }
        //display the array of list items
        function displayItems(arrayItems){
            $('li').remove();
            if(arrayItems.length > 0){
                for(var i=0; i<arrayItems.length;i++){
                    $("#toDoItemList").append('<li class="list">'+ arrayItems[i] +'<a href="#pop1" class="edit"'+'data-rel="popup" data-'+'theme="a">Edit</a>'+'<a href="#" class="close"'+' data-'+'role="button" data-theme="a">x</a></li>');
                }
            }
            else {
                return;
            }
        }

        //save the array to local storage
		function populateStorage(ind, setItems){
            localStorage[ind] = JSON.stringify(setItems);
         }

	});
	</script>
</body>
</html>
