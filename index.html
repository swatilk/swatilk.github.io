<!DOCTYPE html>
<html>
<head>
    <title>My Page</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.css">
    <style>
    a {
    	float: right;

    }
    textarea {
    	width:80%;
    }

    </style>
    <script src="https://code.jquery.com/jquery-1.8.2.min.js"></script>
    <!--<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.7/themes/smoothness/jquery-ui.css"></script>-->
    <script>
		$(document).bind('mobileinit',function(){
    	$.mobile.changePage.defaults.changeHash = false;
    	$.mobile.hashListeningEnabled = false;
    	$.mobile.pushStateEnabled = false;
    	$.mobile.allowCrossDomainPages = true;
	});
		</script>
    <script src="https://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.js"></script>
</head>
<body>
	<div data-role="page">
		<div data-role="header">
			<h1>To-Do List</h1>
		</div>
		<div data-role="content">
			<ul id="toDoItemList" data-role="listview" data-inset="true"></ul>
		</div>
		<form action="#" method="post" id="listForm">
            <div data-role="fieldcontain">
                <label for="newItem">Enter to-do Item</label>
                <input type="text" placeholder="Enter your to-do item" id="newItem"/>
                <input id="addItem" type="submit" value="Add" id="addButton"/>
            </div>
        </form>

        <div data-role="popup" id="pop1" data-position-to="window">
          <a href="#" data-rel="back" data-role="button" data-theme="a" data-icon="delete" data-iconpos="notext" class="ui-btn-right">Close</a>
          <div data-role="header" data-theme="b"><h1>Edit your item</h1></div>
          <p class="ui-bar ui-bar-e">
          <textarea id="editArea"></textarea>
          <a href="#" data-rel="back" data-role="button" data-theme="a" id="saveEdit">Save Changes</a>
      </p>
  </div>
	</div>
	<script>
    $(function(){

        var theList = $("#toDoItemList"),
            item = $("#newItem"),
            addButton = $("#addItem"),
            counter = 0,
            index;
            //$('#toDoItemList').listview('refresh')
        $("#listForm").on('submit',function(event){



            var listText = $("#newItem").val();
            storedItemList.push(listText);
            console.log("new storedItemList", storedItemList);
            $("#newItem").val('');
            displayValues(storedItemList);
            populateStorage('memos',storedItemList);
            event.preventDefault();
            return false;


    });
        //delete a list item
        $("#toDoItemList").delegate('a.close','tap click',function(event){
            /*var t = event.target;
            if(t.nodeName === 'A' || t.nodeName === 'TEXTAREA' || t.nodeName === 'LI' || t.nodeName === 'UL'){
                if($(this).closest("li").hasClass('list')){
                    //this.parentNode.removeChild( this );
                    console.log("remove",this.closest("li"));
                    this.closest("li").remove("li");
                    counter -= 1;
                }
                else {
                    $(this).closest("li").addClass('list');
                }
                populateStorage();
            };
            event.preventDefault();
            return false;*/
            event.stopPropagation();
             index = $(".close").index(this);
            $('li').eq(index).remove();
            storedItemList.splice(index, 1);
            console.log("storedItemList after deleting", storedItemList, index);
            populateStorage('memos', storedItemList);
            event.preventDefault();
            return false;
        });

        //edit element
        $('ul').delegate('li', 'click', function(event){
            index = $('li').index(this);
            var content = storedItemList[index];
            console.log(content, index);
            $('#pop1').val(content);
            $('#editArea').val(content);
            event.preventDefault();
            //return false;

            $('#saveEdit').click(function(event){
        //event.stopPropagation();
            console.log("save button",storedItemList[index]);
            storedItemList[index] = $('#editArea').val();
            console.log("index",index);
            console.log("save button",storedItemList[index]);
            displayValues(storedItemList);
            populateStorage('memos', storedItemList);
            event.preventDefault();
            });
        });




        $(document).ready(function(){
            storedItemList = retrieveValues('memos');
            console.log("local",storedItemList);
            displayValues(storedItemList);

        });

        function populateStorage(key, storeItems){
            localStorage[key] = JSON.stringify(storeItems);
         }

        function retrieveValues(key){
            if(localStorage[key]){
                return (JSON.parse(localStorage[key]));
            }
            else
                return [ ];
        }

        function displayValues(itemList){
            //var storedItemList;
            //if(localStorage.getItem('ItemList')){
              //  storedItemList = JSON.parse(localStorage.getItem('ItemList'));
                    $('li').remove();
                    if(itemList.length > 0){
                        for(var i=0; i < itemList.length;i++){

                            $("#toDoItemList").append('<li class="list">'+ itemList[i] +
                                '<a href="#pop1" class="edit" data-'+'rel="popup" data-inline="true">'+'Edit</a>'+'<a href="#" data-icon="delete" class="close" data-theme="c">x</a></li>');

                    }
                    }
                    else{
                        return;
                    }
            }

    });
    </script>
</body>
</html>
